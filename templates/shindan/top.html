{% load static %}
{% load manage_tags %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ plugin_name }} | {{ site_title }}</title>

    <!-- OGP -->
    <meta property="og:title" content="{{ plugin_name }} | {{ site_title }}">
    <meta property="og:description" content="{{ plugin_description|default:'質問に答えて、あなたの野鳥撮影スタイルをAIが診断！あなたに似た野鳥も見つかります。' }}">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ja_JP">
    {% if site_url %}<meta property="og:url" content="{{ site_url }}/plugins/shindan/">{% endif %}
    {% if og_image %}<meta property="og:image" content="{{ og_image }}">{% endif %}
    {% if site_title %}<meta property="og:site_name" content="{{ site_title }}">{% endif %}

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap">

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'shindan/css/common/base.css' %}">
    <link rel="stylesheet" href="{% static 'shindan/css/pages/top.css' %}">

    <!-- AdSense（自動広告を無効化し、手動配置のみ使用） -->
    {% if detect_ad_blocker %}<script>window.__adsBlocked=true;</script>{% endif %}
    {% if adsense_publisher_id %}
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" crossorigin="anonymous"{% if detect_ad_blocker %} onload="window.__adsBlocked=false"{% endif %}></script>
    <script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"{{ adsense_publisher_id }}",enable_page_level_ads:false});</script>
    {% endif %}
    <style>.adsense-auto-ads-ignore { google-auto-ads: ignore; }</style>
    {% if detect_ad_blocker %}
    <style>
        .ab-overlay-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9999}
        .ab-overlay-box{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10000;background:#fff;border-radius:12px;padding:2.5rem 2rem;max-width:440px;width:calc(100% - 2rem);text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.3)}
        .ab-overlay-icon{width:48px;height:48px;color:#e53e3e;margin-bottom:1rem}
        .ab-overlay-title{font-size:1.125rem;font-weight:700;color:#1a1a1a;margin:0 0 .75rem}
        .ab-overlay-text{font-size:.875rem;color:#555;line-height:1.7;margin:0 0 1.5rem}
        .ab-overlay-btn{display:inline-block;padding:.625rem 1.5rem;font-size:.875rem;font-weight:600;color:#fff;background:#2563eb;border:none;border-radius:6px;cursor:pointer}
        .ab-overlay-btn:hover{background:#1d4ed8}
    </style>
    {% endif %}
</head>
<body class="adsense-auto-ads-ignore">
    {% if detect_ad_blocker %}
    <div id="ab-overlay" style="display:none;">
        <div class="ab-overlay-bg"></div>
        <div class="ab-overlay-box">
            <svg class="ab-overlay-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <h2 class="ab-overlay-title">広告ブロッカーが検出されました</h2>
            <p class="ab-overlay-text">このサイトは広告収入により運営されています。<br>コンテンツをご覧いただくには、広告ブロッカーを無効にしてください。</p>
            <button class="ab-overlay-btn" onclick="location.reload()">無効にしたのでリロード</button>
        </div>
    </div>
    {% endif %}

    <!-- React マウントポイント -->
    <div id="shindan-root"></div>

    <!-- サーバーデータ注入 -->
    <script id="shindan-data" type="application/json">{{ shindan_data_json|safe }}</script>
    <script>
        window.SHINDAN_CONFIG = {
            adsensePublisherId: '{{ adsense_publisher_id }}',
            adUnitId: '{{ ad_unit_id }}',
            adPreview: {{ ad_preview|yesno:"true,false" }},
            siteUrl: '{{ site_url }}',
            siteTitle: '{{ site_title|escapejs }}',
            csrfToken: '{{ csrf_token }}',
            title: '{{ plugin_name|escapejs }}',
            description: '{{ plugin_description|escapejs }}',
            topImageUrl: '{{ top_image_url }}',
        };
    </script>

    <!-- CDN: React / ReactDOM -->
    {% is_react_dev_mode as react_dev %}
    {% if react_dev %}
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    {% else %}
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    {% endif %}

    <!-- CDN: Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

    <!-- Shindan App -->
    {% react_page 'shindan/js/pages/top.jsx' %}

    {% if detect_ad_blocker %}
    <script>
    (function() {
        function showOverlay() {
            document.getElementById('ab-overlay').style.display = '';
            document.body.style.overflow = 'hidden';
        }
        if (window.__adsBlocked === false) return;
        if (window.__adsBlocked === true) { showOverlay(); return; }
        setTimeout(function() { if (window.__adsBlocked) showOverlay(); }, 1500);
    })();
    </script>
    {% endif %}
</body>
</html>
